use chess::{
    definitions::NumberOf,
    pieces::Piece,
    side::Side,
    square::{self},
};

use crate::{
    phased_score::{PhasedScore, S},
    score::ScoreType,
    traits::EvalValues,
};

/// Game phase increment for each piece
/// Ordered to match the indexing of [`Piece`]
/// King, Queen, Rook, Bishop, Knight, Pawn
pub const GAME_PHASE_INC: [ScoreType; 6] = [0, 4, 2, 1, 1, 0];

/// Maximum game phase
pub const GAME_PHASE_MAX: i32 = 24;

/// Piece-Square Tables, ordered by the ordinality of the pieces. See ['pieces::Piece']
#[rustfmt::skip]
pub const PSQTS : [[PhasedScore; NumberOf::SQUARES]; NumberOf::PIECE_TYPES] = [
    // King
    [
        S(  17,  -99), S(   1,  -44), S(  17,  -26), S(-121,   25), S( -78,    7), S(  -9,    5), S(  61,   -7), S( 181, -125),
        S(-112,    4), S( -73,   38), S(-109,   50), S(  -8,   34), S( -55,   53), S( -49,   65), S(   5,   51), S( -12,   17),
        S(-133,   20), S( -16,   40), S( -90,   62), S(-115,   74), S( -70,   72), S(  16,   64), S(  -4,   61), S( -46,   30),
        S( -94,   10), S(-108,   47), S(-124,   68), S(-176,   81), S(-163,   81), S(-122,   75), S(-116,   63), S(-142,   35),
        S( -99,    0), S(-102,   33), S(-140,   60), S(-171,   78), S(-166,   75), S(-124,   61), S(-129,   47), S(-157,   30),
        S( -45,  -12), S( -30,   15), S( -92,   40), S(-105,   53), S( -99,   53), S( -96,   43), S( -47,   21), S( -65,    7),
        S(  51,  -32), S(   5,   -2), S( -10,   11), S( -47,   22), S( -49,   26), S( -29,   16), S(  22,   -4), S(  33,  -24),
        S(  46,  -73), S(  70,  -50), S(  41,  -29), S( -67,  -10), S(   3,  -37), S( -40,  -11), S(  50,  -41), S(  52,  -71),
    ],
    // Queen
    [
        S( 791, 1350), S( 802, 1361), S( 832, 1380), S( 867, 1368), S( 866, 1367), S( 878, 1352), S( 897, 1306), S( 836, 1344),
        S( 833, 1312), S( 808, 1357), S( 815, 1392), S( 807, 1414), S( 813, 1431), S( 854, 1385), S( 828, 1373), S( 879, 1345),
        S( 834, 1320), S( 831, 1340), S( 829, 1382), S( 845, 1385), S( 850, 1401), S( 897, 1380), S( 898, 1341), S( 895, 1330),
        S( 815, 1335), S( 820, 1357), S( 825, 1371), S( 823, 1398), S( 825, 1412), S( 839, 1397), S( 839, 1383), S( 845, 1360),
        S( 818, 1329), S( 815, 1360), S( 815, 1368), S( 823, 1391), S( 822, 1390), S( 821, 1380), S( 833, 1357), S( 836, 1346),
        S( 815, 1314), S( 823, 1333), S( 817, 1359), S( 817, 1358), S( 819, 1362), S( 827, 1351), S( 841, 1326), S( 834, 1313),
        S( 813, 1311), S( 819, 1314), S( 830, 1311), S( 829, 1321), S( 828, 1325), S( 837, 1296), S( 843, 1262), S( 854, 1233),
        S( 811, 1304), S( 800, 1312), S( 808, 1314), S( 824, 1303), S( 815, 1308), S( 801, 1307), S( 825, 1274), S( 817, 1278),
    ],
    // Rook
    [
        S( 447,  718), S( 438,  725), S( 445,  735), S( 449,  731), S( 470,  721), S( 486,  710), S( 466,  714), S( 491,  706),
        S( 428,  718), S( 426,  730), S( 446,  734), S( 468,  725), S( 453,  725), S( 485,  708), S( 471,  704), S( 505,  692),
        S( 406,  717), S( 428,  719), S( 431,  720), S( 433,  718), S( 464,  703), S( 470,  695), S( 509,  687), S( 484,  684),
        S( 389,  720), S( 403,  718), S( 407,  726), S( 414,  722), S( 421,  706), S( 425,  698), S( 434,  698), S( 434,  690),
        S( 368,  713), S( 371,  718), S( 382,  719), S( 394,  717), S( 395,  712), S( 381,  710), S( 406,  697), S( 395,  693),
        S( 360,  707), S( 371,  706), S( 381,  706), S( 380,  710), S( 386,  705), S( 384,  698), S( 420,  676), S( 396,  678),
        S( 357,  701), S( 370,  706), S( 387,  705), S( 383,  706), S( 388,  697), S( 391,  694), S( 409,  683), S( 376,  691),
        S( 378,  695), S( 380,  705), S( 390,  713), S( 396,  711), S( 400,  703), S( 389,  698), S( 407,  695), S( 380,  685),
    ],
    // Bishop
    [
        S( 301,  393), S( 280,  410), S( 291,  403), S( 249,  418), S( 262,  410), S( 278,  402), S( 313,  398), S( 269,  392),
        S( 318,  384), S( 343,  401), S( 337,  407), S( 320,  409), S( 351,  399), S( 349,  399), S( 339,  405), S( 330,  379),
        S( 331,  411), S( 355,  406), S( 356,  416), S( 380,  406), S( 366,  410), S( 399,  413), S( 375,  405), S( 363,  406),
        S( 321,  407), S( 338,  423), S( 359,  418), S( 370,  432), S( 367,  425), S( 363,  422), S( 337,  422), S( 322,  407),
        S( 316,  405), S( 328,  422), S( 336,  430), S( 356,  428), S( 353,  426), S( 337,  425), S( 329,  418), S( 323,  392),
        S( 325,  403), S( 335,  414), S( 333,  423), S( 338,  423), S( 338,  428), S( 333,  421), S( 335,  404), S( 339,  392),
        S( 329,  397), S( 329,  397), S( 343,  395), S( 319,  411), S( 327,  412), S( 339,  400), S( 347,  401), S( 333,  376),
        S( 305,  376), S( 328,  397), S( 309,  377), S( 301,  400), S( 305,  395), S( 304,  395), S( 329,  382), S( 317,  361),
    ],
    // Knight
    [
        S( 134,  294), S( 175,  359), S( 238,  380), S( 272,  369), S( 308,  373), S( 246,  350), S( 194,  362), S( 191,  272),
        S( 277,  358), S( 296,  378), S( 324,  386), S( 345,  384), S( 326,  378), S( 393,  360), S( 295,  374), S( 322,  339),
        S( 296,  371), S( 333,  388), S( 350,  406), S( 363,  408), S( 402,  390), S( 407,  382), S( 358,  379), S( 326,  361),
        S( 291,  386), S( 306,  406), S( 333,  419), S( 355,  421), S( 336,  421), S( 363,  416), S( 317,  406), S( 328,  376),
        S( 277,  386), S( 293,  397), S( 310,  421), S( 311,  422), S( 321,  425), S( 316,  413), S( 314,  398), S( 289,  376),
        S( 257,  368), S( 281,  389), S( 296,  400), S( 300,  415), S( 312,  413), S( 301,  395), S( 305,  382), S( 275,  369),
        S( 243,  361), S( 255,  377), S( 274,  387), S( 286,  388), S( 287,  387), S( 290,  384), S( 275,  366), S( 273,  370),
        S( 197,  352), S( 254,  334), S( 240,  370), S( 256,  371), S( 261,  372), S( 274,  361), S( 256,  342), S( 229,  345),
    ],
    // Pawn
    [
        S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0),
        S( 169,  318), S( 191,  308), S( 171,  306), S( 201,  247), S( 179,  247), S( 168,  264), S( 105,  310), S(  70,  325),
        S(  81,  165), S(  95,  170), S( 127,  122), S( 126,   82), S( 136,   78), S( 172,  104), S( 148,  146), S( 100,  148),
        S(  59,  148), S(  81,  143), S(  87,  120), S(  88,  100), S( 112,  100), S( 106,  112), S( 109,  131), S(  82,  125),
        S(  47,  131), S(  72,  134), S(  74,  116), S(  90,  106), S(  90,  107), S(  84,  116), S(  92,  124), S(  67,  113),
        S(  45,  125), S(  68,  132), S(  71,  116), S(  70,  118), S(  86,  118), S(  78,  120), S( 109,  121), S(  73,  109),
        S(  45,  129), S(  68,  134), S(  65,  123), S(  53,  117), S(  75,  128), S(  92,  123), S( 117,  119), S(  65,  109),
        S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0), S(   0,    0),
    ],
];

pub const PASSED_PAWN_BONUS: [PhasedScore; NumberOf::PASSED_PAWN_RANKS] = [
    S(-19, 7),
    S(4, 119),
    S(8, 52),
    S(-16, 25),
    S(-21, 1),
    S(-14, -2),
];

pub const DOUBLED_PAWN_VALUES: [PhasedScore; NumberOf::DOUBLED_PAWN_FILES] = [
    S(-21, -46),
    S(-3, -38),
    S(-16, -35),
    S(-11, -23),
    S(-19, -22),
    S(-17, -35),
    S(-20, -34),
    S(-24, -51),
];

const RANK_1: u8 = 1;

#[derive(Debug, Clone, Copy, Default)]
pub struct ByteKnightValues {}

impl EvalValues for ByteKnightValues {
    type ReturnScore = PhasedScore;

    fn psqt(&self, square: u8, piece: Piece, side: Side) -> Self::ReturnScore {
        PSQTS[piece as usize][square::flip_if(side == Side::White, square) as usize]
    }

    fn passed_pawn_bonus(&self, square: u8, side: Side) -> Self::ReturnScore {
        let (_file, rank) = square::from_square(square::flip_if(side == Side::White, square));
        PASSED_PAWN_BONUS[(rank - RANK_1) as usize]
    }

    fn doubled_pawn_value(&self, square: u8, side: Side) -> Self::ReturnScore {
        let (file, _rank) = square::from_square(square::flip_if(side == Side::White, square));
        DOUBLED_PAWN_VALUES[file as usize]
    }
}
